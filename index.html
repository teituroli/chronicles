<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Campaign Chronicle</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=DM+Mono:wght@400;500&family=Syne:wght@400;600;700;800&family=DM+Sans:wght@300;400;500&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0a0a0b;
    --surface: #111114;
    --surface2: #18181d;
    --surface3: #1e1e25;
    --border: #2a2a35;
    --border2: #3a3a48;
    --accent: #e8ff47;
    --accent2: #7c6fff;
    --accent3: #ff6b6b;
    --text: #f0f0f5;
    --text2: #9090a8;
    --text3: #606075;
    --mono: 'DM Mono', monospace;
    --sans: 'DM Sans', sans-serif;
    --display: 'Syne', sans-serif;
    --radius: 6px;
    --sidebar-w: 220px;
    --transition: 0.15s ease;
  }

  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    font-family: var(--sans);
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    font-size: 14px;
    line-height: 1.6;
  }

  /* ‚îÄ‚îÄ TOP BAR ‚îÄ‚îÄ */
  #topbar {
    height: 52px;
    background: var(--surface);
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    padding: 0 20px;
    gap: 16px;
    flex-shrink: 0;
    position: sticky;
    top: 0;
    z-index: 100;
  }

  #logo {
    font-family: var(--display);
    font-weight: 800;
    font-size: 16px;
    color: var(--accent);
    letter-spacing: -0.5px;
    white-space: nowrap;
  }

  #logo span { color: var(--text3); font-weight: 400; }

  #campaign-selector {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-left: auto;
  }

  #campaign-select {
    background: var(--surface2);
    border: 1px solid var(--border);
    color: var(--text);
    font-family: var(--sans);
    font-size: 13px;
    padding: 5px 10px;
    border-radius: var(--radius);
    cursor: pointer;
    outline: none;
    max-width: 200px;
  }
  #campaign-select:focus { border-color: var(--accent2); }

  .btn {
    font-family: var(--sans);
    font-size: 12px;
    font-weight: 500;
    padding: 6px 12px;
    border-radius: var(--radius);
    border: none;
    cursor: pointer;
    transition: all var(--transition);
    white-space: nowrap;
    display: inline-flex;
    align-items: center;
    gap: 5px;
  }

  .btn-accent { background: var(--accent); color: #000; }
  .btn-accent:hover { background: #d4e83f; }
  .btn-ghost { background: transparent; color: var(--text2); border: 1px solid var(--border); }
  .btn-ghost:hover { border-color: var(--border2); color: var(--text); }
  .btn-danger { background: transparent; color: var(--accent3); border: 1px solid var(--accent3)22; }
  .btn-danger:hover { background: var(--accent3)22; }
  .btn-primary { background: var(--accent2); color: #fff; }
  .btn-primary:hover { background: #6a5ef0; }

  /* ‚îÄ‚îÄ LAYOUT ‚îÄ‚îÄ */
  #app { display: flex; flex: 1; overflow: hidden; height: calc(100vh - 52px); }

  /* ‚îÄ‚îÄ SIDEBAR ‚îÄ‚îÄ */
  #sidebar {
    width: var(--sidebar-w);
    background: var(--surface);
    border-right: 1px solid var(--border);
    display: flex;
    flex-direction: column;
    overflow-y: auto;
    flex-shrink: 0;
  }

  .nav-section {
    padding: 8px 0;
    border-bottom: 1px solid var(--border);
  }

  .nav-label {
    font-family: var(--mono);
    font-size: 10px;
    color: var(--text3);
    text-transform: uppercase;
    letter-spacing: 1.5px;
    padding: 8px 16px 4px;
  }

  .nav-item {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 7px 16px;
    cursor: pointer;
    transition: all var(--transition);
    color: var(--text2);
    font-size: 13px;
    border-left: 2px solid transparent;
    user-select: none;
  }

  .nav-item:hover { background: var(--surface2); color: var(--text); }
  .nav-item.active { background: var(--surface2); color: var(--accent); border-left-color: var(--accent); }
  .nav-icon { font-size: 14px; width: 16px; text-align: center; }

  /* ‚îÄ‚îÄ MAIN ‚îÄ‚îÄ */
  #main {
    flex: 1;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
  }

  .page { display: none; flex-direction: column; flex: 1; }
  .page.active { display: flex; }

  .page-header {
    padding: 28px 32px 20px;
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: flex-start;
    gap: 16px;
    justify-content: space-between;
  }

  .page-title {
    font-family: var(--display);
    font-size: 22px;
    font-weight: 700;
    color: var(--text);
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .page-sub { color: var(--text3); font-size: 12px; margin-top: 2px; font-family: var(--mono); }

  .page-body { padding: 24px 32px; flex: 1; }

  /* ‚îÄ‚îÄ CARDS ‚îÄ‚îÄ */
  .card-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
    gap: 16px;
  }

  .card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 16px;
    transition: border-color var(--transition);
    position: relative;
  }

  .card:hover { border-color: var(--border2); }

  .card-top {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 10px;
  }

  .card-title {
    font-family: var(--display);
    font-weight: 600;
    font-size: 15px;
    color: var(--text);
  }

  .card-meta { font-size: 11px; color: var(--text3); font-family: var(--mono); margin-top: 3px; }

  .card-body { color: var(--text2); font-size: 13px; line-height: 1.6; }

  .card-actions {
    display: flex;
    gap: 6px;
    margin-top: 14px;
    padding-top: 12px;
    border-top: 1px solid var(--border);
  }

  .badge {
    display: inline-block;
    padding: 2px 8px;
    border-radius: 100px;
    font-size: 10px;
    font-family: var(--mono);
    font-weight: 500;
    letter-spacing: 0.5px;
  }

  .badge-yellow { background: var(--accent)22; color: var(--accent); }
  .badge-purple { background: var(--accent2)22; color: var(--accent2); }
  .badge-red { background: var(--accent3)22; color: var(--accent3); }
  .badge-green { background: #47ff8722; color: #47ff87; }
  .badge-gray { background: var(--surface3); color: var(--text3); }

  .tag {
    display: inline-block;
    padding: 1px 7px;
    background: var(--surface3);
    border: 1px solid var(--border);
    border-radius: 100px;
    font-size: 10px;
    font-family: var(--mono);
    color: var(--text3);
    margin: 2px;
  }

  /* ‚îÄ‚îÄ EMPTY STATE ‚îÄ‚îÄ */
  .empty {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 80px 20px;
    text-align: center;
    color: var(--text3);
    gap: 12px;
  }

  .empty-icon { font-size: 36px; opacity: 0.4; }
  .empty-title { font-family: var(--display); font-size: 16px; color: var(--text2); }
  .empty-sub { font-size: 12px; max-width: 280px; }

  /* ‚îÄ‚îÄ MODAL ‚îÄ‚îÄ */
  .modal-overlay {
    display: none;
    position: fixed;
    inset: 0;
    background: #000000cc;
    z-index: 1000;
    align-items: center;
    justify-content: center;
    padding: 20px;
    backdrop-filter: blur(4px);
  }

  .modal-overlay.open { display: flex; }

  .modal {
    background: var(--surface);
    border: 1px solid var(--border2);
    border-radius: 10px;
    width: 100%;
    max-width: 680px;
    max-height: 90vh;
    overflow-y: auto;
    box-shadow: 0 32px 64px #00000088;
  }

  .modal-header {
    padding: 20px 24px 16px;
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    justify-content: space-between;
    position: sticky;
    top: 0;
    background: var(--surface);
    z-index: 1;
  }

  .modal-title { font-family: var(--display); font-weight: 700; font-size: 17px; }

  .modal-close {
    background: none;
    border: none;
    color: var(--text3);
    font-size: 20px;
    cursor: pointer;
    line-height: 1;
    padding: 4px;
    transition: color var(--transition);
  }
  .modal-close:hover { color: var(--text); }

  .modal-body { padding: 20px 24px; }
  .modal-footer {
    padding: 16px 24px;
    border-top: 1px solid var(--border);
    display: flex;
    justify-content: flex-end;
    gap: 8px;
  }

  /* ‚îÄ‚îÄ FORM ‚îÄ‚îÄ */
  .form-grid { display: grid; gap: 16px; }
  .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }

  .form-group { display: flex; flex-direction: column; gap: 5px; }

  label {
    font-size: 11px;
    font-family: var(--mono);
    color: var(--text3);
    text-transform: uppercase;
    letter-spacing: 0.8px;
  }

  input[type=text], input[type=number], textarea, select {
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    color: var(--text);
    font-family: var(--sans);
    font-size: 13px;
    padding: 8px 12px;
    outline: none;
    transition: border-color var(--transition);
    width: 100%;
  }

  input:focus, textarea:focus, select:focus { border-color: var(--accent2); }

  textarea { resize: vertical; min-height: 80px; }

  select { cursor: pointer; }

  .section-title {
    font-family: var(--display);
    font-size: 12px;
    font-weight: 600;
    color: var(--text3);
    text-transform: uppercase;
    letter-spacing: 1px;
    border-bottom: 1px solid var(--border);
    padding-bottom: 8px;
    margin-bottom: 14px;
  }

  /* ‚îÄ‚îÄ TRUST STARS ‚îÄ‚îÄ */
  .trust-stars { display: flex; gap: 3px; }
  .star { color: var(--text3); font-size: 12px; }
  .star.filled { color: var(--accent); }

  /* ‚îÄ‚îÄ DETAIL VIEW ‚îÄ‚îÄ */
  .detail-section {
    margin-bottom: 20px;
  }

  .detail-label {
    font-family: var(--mono);
    font-size: 10px;
    color: var(--text3);
    text-transform: uppercase;
    letter-spacing: 1px;
    margin-bottom: 6px;
  }

  .detail-value {
    color: var(--text2);
    font-size: 13px;
    line-height: 1.7;
    white-space: pre-wrap;
  }

  /* ‚îÄ‚îÄ SEARCH BAR ‚îÄ‚îÄ */
  .search-bar {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 20px;
  }

  .search-input {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    color: var(--text);
    font-family: var(--sans);
    font-size: 13px;
    padding: 7px 12px;
    outline: none;
    flex: 1;
    transition: border-color var(--transition);
  }
  .search-input:focus { border-color: var(--accent2); }

  /* ‚îÄ‚îÄ SETTINGS ‚îÄ‚îÄ */
  .settings-block {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 20px;
    margin-bottom: 16px;
  }

  .settings-block h3 {
    font-family: var(--display);
    font-size: 14px;
    font-weight: 600;
    margin-bottom: 14px;
    color: var(--text);
  }

  /* ‚îÄ‚îÄ STATUS INDICATOR ‚îÄ‚îÄ */
  #sync-status {
    font-family: var(--mono);
    font-size: 11px;
    color: var(--text3);
    display: flex;
    align-items: center;
    gap: 5px;
  }

  .status-dot {
    width: 6px;
    height: 6px;
    border-radius: 50%;
    background: var(--text3);
  }
  .status-dot.ok { background: #47ff87; }
  .status-dot.err { background: var(--accent3); }
  .status-dot.loading {
    background: var(--accent);
    animation: pulse 1s infinite;
  }

  @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.3} }

  /* ‚îÄ‚îÄ QUEST BOARD ‚îÄ‚îÄ */
  .quest-columns {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
    gap: 16px;
  }

  .quest-column {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 14px;
  }

  .quest-column-title {
    font-family: var(--display);
    font-size: 12px;
    font-weight: 600;
    color: var(--text3);
    text-transform: uppercase;
    letter-spacing: 0.8px;
    margin-bottom: 12px;
    display: flex;
    align-items: center;
    gap: 6px;
  }

  .quest-item {
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 10px 12px;
    margin-bottom: 8px;
    cursor: pointer;
    transition: border-color var(--transition);
  }

  .quest-item:hover { border-color: var(--border2); }

  .quest-item-title {
    font-size: 13px;
    font-weight: 500;
    color: var(--text);
    margin-bottom: 4px;
  }

  /* ‚îÄ‚îÄ REPUTATION ‚îÄ‚îÄ */
  .rep-bar-wrap {
    margin-bottom: 12px;
  }

  .rep-bar-label {
    display: flex;
    justify-content: space-between;
    font-size: 12px;
    color: var(--text2);
    margin-bottom: 4px;
  }

  .rep-bar-bg {
    height: 6px;
    background: var(--surface3);
    border-radius: 100px;
    overflow: hidden;
  }

  .rep-bar-fill {
    height: 100%;
    border-radius: 100px;
    background: linear-gradient(90deg, var(--accent3), var(--accent));
    transition: width 0.4s ease;
  }

  /* ‚îÄ‚îÄ TIMELINE ‚îÄ‚îÄ */
  .timeline { position: relative; padding-left: 24px; }
  .timeline::before {
    content: '';
    position: absolute;
    left: 6px;
    top: 8px;
    bottom: 8px;
    width: 1px;
    background: var(--border);
  }

  .timeline-item {
    position: relative;
    margin-bottom: 20px;
  }

  .timeline-dot {
    position: absolute;
    left: -21px;
    top: 5px;
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: var(--accent2);
    border: 2px solid var(--bg);
  }

  .timeline-date {
    font-family: var(--mono);
    font-size: 10px;
    color: var(--text3);
    margin-bottom: 3px;
  }

  .timeline-content {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 12px;
  }

  /* ‚îÄ‚îÄ NO CAMPAIGN ‚îÄ‚îÄ */
  #no-campaign {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    flex: 1;
    gap: 16px;
    text-align: center;
    padding: 40px;
  }

  #no-campaign h2 {
    font-family: var(--display);
    font-size: 20px;
    font-weight: 700;
  }

  #no-campaign p { color: var(--text3); font-size: 13px; max-width: 320px; }

  /* ‚îÄ‚îÄ QUOTE LOG ‚îÄ‚îÄ */
  .quote-item {
    border-left: 2px solid var(--accent2);
    padding: 8px 14px;
    margin-bottom: 10px;
    background: var(--surface);
    border-radius: 0 var(--radius) var(--radius) 0;
  }

  .quote-text { font-style: italic; color: var(--text2); font-size: 13px; }
  .quote-attr { font-family: var(--mono); font-size: 10px; color: var(--text3); margin-top: 4px; }

  /* ‚îÄ‚îÄ THEORY WEB ‚îÄ‚îÄ */
  .theory-item {
    background: var(--surface);
    border: 1px solid var(--border);
    border-left: 3px solid var(--accent);
    border-radius: var(--radius);
    padding: 14px;
    margin-bottom: 12px;
  }

  .inventory-section {
    margin-bottom: 24px;
  }

  .inventory-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 13px;
  }

  .inventory-table th {
    font-family: var(--mono);
    font-size: 10px;
    text-transform: uppercase;
    color: var(--text3);
    letter-spacing: 0.8px;
    padding: 6px 10px;
    text-align: left;
    border-bottom: 1px solid var(--border);
  }

  .inventory-table td {
    padding: 8px 10px;
    border-bottom: 1px solid var(--border);
    color: var(--text2);
  }

  .inventory-table tr:last-child td { border-bottom: none; }
  .inventory-table tr:hover td { background: var(--surface2); color: var(--text); }

  /* ‚îÄ‚îÄ SCROLLBAR ‚îÄ‚îÄ */
  ::-webkit-scrollbar { width: 5px; height: 5px; }
  ::-webkit-scrollbar-track { background: transparent; }
  ::-webkit-scrollbar-thumb { background: var(--border2); border-radius: 10px; }
  ::-webkit-scrollbar-thumb:hover { background: var(--text3); }
</style>
</head>
<body>

<!-- TOP BAR -->
<div id="topbar">
  <div id="logo">Chronicle <span>/ TTRPG</span></div>
  <div id="sync-status">
    <div class="status-dot" id="sync-dot"></div>
    <span id="sync-text">Not connected</span>
  </div>
  <div id="campaign-selector">
    <select id="campaign-select"><option value="">‚Äî Select Campaign ‚Äî</option></select>
    <button class="btn btn-ghost" onclick="openNewCampaignModal()">+ Campaign</button>
    <button class="btn btn-ghost" onclick="showPage('settings')">‚öô</button>
  </div>
</div>

<!-- APP -->
<div id="app">
  <!-- SIDEBAR -->
  <nav id="sidebar">
    <div class="nav-section">
      <div class="nav-label">Chapters</div>
      <div class="nav-item active" data-page="sessions" onclick="showPage('sessions')">
        <span class="nav-icon">üìñ</span> Sessions
      </div>
      <div class="nav-item" data-page="npcs" onclick="showPage('npcs')">
        <span class="nav-icon">üë•</span> NPCs
      </div>
      <div class="nav-item" data-page="creatures" onclick="showPage('creatures')">
        <span class="nav-icon">üëπ</span> Bestiary
      </div>
      <div class="nav-item" data-page="locations" onclick="showPage('locations')">
        <span class="nav-icon">üó∫Ô∏è</span> Locations
      </div>
      <div class="nav-item" data-page="quests" onclick="showPage('quests')">
        <span class="nav-icon">üéØ</span> Quests
      </div>
      <div class="nav-item" data-page="inventory" onclick="showPage('inventory')">
        <span class="nav-icon">üéí</span> Inventory
      </div>
    </div>
    <div class="nav-section">
      <div class="nav-label">Meta</div>
      <div class="nav-item" data-page="theories" onclick="showPage('theories')">
        <span class="nav-icon">üß†</span> Theories
      </div>
      <div class="nav-item" data-page="party" onclick="showPage('party')">
        <span class="nav-icon">üé≠</span> Party Web
      </div>
      <div class="nav-item" data-page="memory" onclick="showPage('memory')">
        <span class="nav-icon">üî•</span> Memory Log
      </div>
      <div class="nav-item" data-page="reputation" onclick="showPage('reputation')">
        <span class="nav-icon">üîÑ</span> Reputation
      </div>
    </div>
    <div class="nav-section">
      <div class="nav-label">System</div>
      <div class="nav-item" data-page="settings" onclick="showPage('settings')">
        <span class="nav-icon">‚öôÔ∏è</span> Settings
      </div>
    </div>
  </nav>

  <!-- MAIN -->
  <main id="main">
    <!-- NO CAMPAIGN -->
    <div id="no-campaign" style="display:none;">
      <div style="font-size:48px;opacity:0.3">üìñ</div>
      <h2>No Campaign Selected</h2>
      <p>Select a campaign from the top bar or create a new one to begin.</p>
      <button class="btn btn-accent" onclick="openNewCampaignModal()">+ New Campaign</button>
    </div>

    <!-- SESSIONS PAGE -->
    <div class="page active" id="page-sessions">
      <div class="page-header">
        <div>
          <div class="page-title">üìñ Session Chronicle</div>
          <div class="page-sub">The heart of the campaign</div>
        </div>
        <button class="btn btn-accent" onclick="openSessionModal()">+ New Session</button>
      </div>
      <div class="page-body">
        <div class="search-bar">
          <input class="search-input" placeholder="Search sessions..." oninput="filterSessions(this.value)">
        </div>
        <div id="sessions-list" class="card-grid"></div>
      </div>
    </div>

    <!-- NPCS PAGE -->
    <div class="page" id="page-npcs">
      <div class="page-header">
        <div>
          <div class="page-title">üë• NPC Tracker</div>
          <div class="page-sub">Know everyone, trust no one</div>
        </div>
        <button class="btn btn-accent" onclick="openNPCModal()">+ Add NPC</button>
      </div>
      <div class="page-body">
        <div class="search-bar">
          <input class="search-input" placeholder="Search NPCs..." oninput="filterNPCs(this.value)">
          <select id="npc-filter-align" style="width:auto;flex-shrink:0" onchange="filterNPCs(document.querySelector('#page-npcs .search-input').value)">
            <option value="">All alignments</option>
            <option value="Ally">Ally</option>
            <option value="Neutral">Neutral</option>
            <option value="Rival">Rival</option>
            <option value="Threat">Threat</option>
            <option value="Unknown">Unknown</option>
          </select>
        </div>
        <div id="npcs-list" class="card-grid"></div>
      </div>
    </div>

    <!-- CREATURES PAGE -->
    <div class="page" id="page-creatures">
      <div class="page-header">
        <div>
          <div class="page-title">üëπ Bestiary</div>
          <div class="page-sub">Field journal of encountered creatures</div>
        </div>
        <button class="btn btn-accent" onclick="openCreatureModal()">+ Add Creature</button>
      </div>
      <div class="page-body">
        <div class="search-bar">
          <input class="search-input" placeholder="Search creatures..." oninput="filterCreatures(this.value)">
        </div>
        <div id="creatures-list" class="card-grid"></div>
      </div>
    </div>

    <!-- LOCATIONS PAGE -->
    <div class="page" id="page-locations">
      <div class="page-header">
        <div>
          <div class="page-title">üó∫Ô∏è Location Journal</div>
          <div class="page-sub">Places visited, changed, haunted</div>
        </div>
        <button class="btn btn-accent" onclick="openLocationModal()">+ Add Location</button>
      </div>
      <div class="page-body">
        <div class="search-bar">
          <input class="search-input" placeholder="Search locations..." oninput="filterLocations(this.value)">
        </div>
        <div id="locations-list" class="card-grid"></div>
      </div>
    </div>

    <!-- QUESTS PAGE -->
    <div class="page" id="page-quests">
      <div class="page-header">
        <div>
          <div class="page-title">üéØ Quest Board</div>
          <div class="page-sub">Goals, leads, and loose ends</div>
        </div>
        <button class="btn btn-accent" onclick="openQuestModal()">+ Add Quest</button>
      </div>
      <div class="page-body">
        <div id="quests-board" class="quest-columns"></div>
      </div>
    </div>

    <!-- INVENTORY PAGE -->
    <div class="page" id="page-inventory">
      <div class="page-header">
        <div>
          <div class="page-title">üéí Party Inventory</div>
          <div class="page-sub">Shared loot and carried items</div>
        </div>
        <button class="btn btn-accent" onclick="openItemModal()">+ Add Item</button>
      </div>
      <div class="page-body" id="inventory-body"></div>
    </div>

    <!-- THEORIES PAGE -->
    <div class="page" id="page-theories">
      <div class="page-header">
        <div>
          <div class="page-title">üß† Theory Board</div>
          <div class="page-sub">Conspiracies, guesses, and speculation</div>
        </div>
        <button class="btn btn-accent" onclick="openTheoryModal()">+ Add Theory</button>
      </div>
      <div class="page-body">
        <div id="theories-list"></div>
      </div>
    </div>

    <!-- PARTY PAGE -->
    <div class="page" id="page-party">
      <div class="page-header">
        <div>
          <div class="page-title">üé≠ Party Web</div>
          <div class="page-sub">Relationships, bonds, and secrets</div>
        </div>
        <button class="btn btn-accent" onclick="openPartyModal()">+ Add Relationship</button>
      </div>
      <div class="page-body">
        <div id="party-list" class="card-grid"></div>
      </div>
    </div>

    <!-- MEMORY PAGE -->
    <div class="page" id="page-memory">
      <div class="page-header">
        <div>
          <div class="page-title">üî• Memory Log</div>
          <div class="page-sub">Quotes, crits, deaths, and legends</div>
        </div>
        <button class="btn btn-accent" onclick="openMemoryModal()">+ Add Entry</button>
      </div>
      <div class="page-body">
        <div id="memory-list"></div>
      </div>
    </div>

    <!-- REPUTATION PAGE -->
    <div class="page" id="page-reputation">
      <div class="page-header">
        <div>
          <div class="page-title">üîÑ Reputation Tracker</div>
          <div class="page-sub">How factions see the party</div>
        </div>
        <button class="btn btn-accent" onclick="openReputationModal()">+ Add Faction</button>
      </div>
      <div class="page-body">
        <div id="reputation-list"></div>
      </div>
    </div>

    <!-- SETTINGS PAGE -->
    <div class="page" id="page-settings">
      <div class="page-header">
        <div>
          <div class="page-title">‚öôÔ∏è Settings</div>
          <div class="page-sub">GitHub storage configuration</div>
        </div>
      </div>
      <div class="page-body">
        <div class="settings-block">
          <h3>GitHub Storage</h3>
          <div class="form-grid">
            <div class="form-row">
              <div class="form-group">
                <label>Owner / Username</label>
                <input type="text" id="s-owner" placeholder="teituroli">
              </div>
              <div class="form-group">
                <label>Repository</label>
                <input type="text" id="s-repo" placeholder="campaign-data">
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label>Branch</label>
                <input type="text" id="s-branch" placeholder="main">
              </div>
              <div class="form-group">
                <label>Personal Access Token</label>
                <input type="text" id="s-token" placeholder="ghp_...">
              </div>
            </div>
            <button class="btn btn-accent" onclick="saveSettings()" style="width:fit-content">Save & Test Connection</button>
          </div>
        </div>
        <div class="settings-block">
          <h3>Data Management</h3>
          <p style="color:var(--text3);font-size:13px;margin-bottom:12px">Data is stored as JSON files in your GitHub repo. Each campaign gets its own folder.</p>
          <button class="btn btn-ghost" onclick="forceSyncAll()">‚Üª Force Re-sync</button>
        </div>
      </div>
    </div>
  </main>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê MODALS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->

<!-- NEW CAMPAIGN MODAL -->
<div class="modal-overlay" id="modal-campaign">
  <div class="modal" style="max-width:420px">
    <div class="modal-header">
      <div class="modal-title">New Campaign</div>
      <button class="modal-close" onclick="closeModal('modal-campaign')">√ó</button>
    </div>
    <div class="modal-body">
      <div class="form-grid">
        <div class="form-group">
          <label>Campaign Name</label>
          <input type="text" id="c-name" placeholder="e.g. Curse of Strahd">
        </div>
        <div class="form-group">
          <label>System</label>
          <input type="text" id="c-system" placeholder="D&D 5e, Pathfinder, Call of Cthulhu‚Ä¶">
        </div>
        <div class="form-group">
          <label>Party Members (comma-separated)</label>
          <input type="text" id="c-party" placeholder="Aragorn, Gimli, Legolas">
        </div>
        <div class="form-group">
          <label>Description</label>
          <textarea id="c-desc" placeholder="A short blurb about the campaign‚Ä¶"></textarea>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-ghost" onclick="closeModal('modal-campaign')">Cancel</button>
      <button class="btn btn-accent" onclick="createCampaign()">Create Campaign</button>
    </div>
  </div>
</div>

<!-- SESSION MODAL -->
<div class="modal-overlay" id="modal-session">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title" id="session-modal-title">New Session</div>
      <button class="modal-close" onclick="closeModal('modal-session')">√ó</button>
    </div>
    <div class="modal-body">
      <div class="form-grid">
        <div class="form-row">
          <div class="form-group">
            <label>Session #</label>
            <input type="number" id="s-num" placeholder="1" min="1">
          </div>
          <div class="form-group">
            <label>In-Game Date</label>
            <input type="text" id="s-date" placeholder="15th of Harvestmoon, 1492">
          </div>
        </div>
        <div class="form-group">
          <label>Location(s)</label>
          <input type="text" id="s-location" placeholder="The Yawning Portal, Waterdeep">
        </div>
        <div class="form-group">
          <label>Party Members Present</label>
          <input type="text" id="s-present" placeholder="Aragorn, Gimli">
        </div>
        <div class="form-group">
          <div class="section-title">üìù What Happened (Narrative)</div>
          <textarea id="s-narrative" placeholder="Story-style recap of the session‚Ä¶" style="min-height:100px"></textarea>
        </div>
        <div class="form-group">
          <div class="section-title">üß† Important Discoveries</div>
          <textarea id="s-discoveries" placeholder="Clues, lore drops, prophecies, maps‚Ä¶"></textarea>
        </div>
        <div class="form-group">
          <div class="section-title">üë• NPCs Met (quick notes)</div>
          <textarea id="s-npcs" placeholder="Name ‚Äî first impression, what they want‚Ä¶"></textarea>
        </div>
        <div class="form-group">
          <div class="section-title">üëπ Creatures Encountered</div>
          <textarea id="s-creatures" placeholder="Name/type, hostile/neutral, outcome‚Ä¶"></textarea>
        </div>
        <div class="form-group">
          <div class="section-title">üí∞ Loot & Items</div>
          <textarea id="s-loot" placeholder="What was found, who carries it‚Ä¶"></textarea>
        </div>
        <div class="form-group">
          <div class="section-title">‚ùì Unanswered Questions</div>
          <textarea id="s-questions" placeholder="Why did ___ happen? Who is ___ really?"></textarea>
        </div>
        <div class="form-group">
          <label>Tags (comma-separated)</label>
          <input type="text" id="s-tags" placeholder="#undead, #capital-city, #cult">
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-ghost" onclick="closeModal('modal-session')">Cancel</button>
      <button class="btn btn-accent" onclick="saveSession()">Save Session</button>
    </div>
  </div>
</div>

<!-- NPC MODAL -->
<div class="modal-overlay" id="modal-npc">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title" id="npc-modal-title">Add NPC</div>
      <button class="modal-close" onclick="closeModal('modal-npc')">√ó</button>
    </div>
    <div class="modal-body">
      <div class="form-grid">
        <div class="form-row">
          <div class="form-group">
            <label>Name</label>
            <input type="text" id="n-name" placeholder="Tasha Wavecrest">
          </div>
          <div class="form-group">
            <label>Location</label>
            <input type="text" id="n-location" placeholder="Where they reside">
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>Trust Level (1‚Äì5)</label>
            <select id="n-trust">
              <option value="1">1 ‚Äî Distrusted</option>
              <option value="2">2 ‚Äî Suspicious</option>
              <option value="3" selected>3 ‚Äî Neutral</option>
              <option value="4">4 ‚Äî Trusted</option>
              <option value="5">5 ‚Äî Fully Trusted</option>
            </select>
          </div>
          <div class="form-group">
            <label>Party Alignment</label>
            <select id="n-align">
              <option value="Unknown">Unknown</option>
              <option value="Ally">Ally</option>
              <option value="Neutral">Neutral</option>
              <option value="Rival">Rival</option>
              <option value="Threat">Threat</option>
            </select>
          </div>
        </div>
        <div class="form-group">
          <label>First Impression</label>
          <textarea id="n-impression" placeholder="How they came across when first met‚Ä¶"></textarea>
        </div>
        <div class="form-group">
          <label>What They Want</label>
          <textarea id="n-wants" placeholder="Their goals and motivations‚Ä¶"></textarea>
        </div>
        <div class="form-group">
          <label>Known Secrets</label>
          <textarea id="n-secrets" placeholder="What we know or suspect they're hiding‚Ä¶"></textarea>
        </div>
        <div class="form-group">
          <label>Promises Made / Debts Owed</label>
          <textarea id="n-debts" placeholder="Any agreements, favors, or obligations‚Ä¶"></textarea>
        </div>
        <div class="form-group">
          <label>Memorable Quotes</label>
          <textarea id="n-quotes" placeholder='"Never trust a smiling elf."'></textarea>
        </div>
        <div class="form-group">
          <label>Suspicious? Notes</label>
          <textarea id="n-suspicious" placeholder="Red flags, inconsistencies‚Ä¶"></textarea>
        </div>
        <div class="form-group">
          <label>Tags</label>
          <input type="text" id="n-tags" placeholder="#royalty, #cult, #fey">
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-ghost" onclick="closeModal('modal-npc')">Cancel</button>
      <button class="btn btn-accent" onclick="saveNPC()">Save NPC</button>
    </div>
  </div>
</div>

<!-- CREATURE MODAL -->
<div class="modal-overlay" id="modal-creature">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title" id="creature-modal-title">Add Creature</div>
      <button class="modal-close" onclick="closeModal('modal-creature')">√ó</button>
    </div>
    <div class="modal-body">
      <div class="form-grid">
        <div class="form-row">
          <div class="form-group">
            <label>Name / Type</label>
            <input type="text" id="cr-name" placeholder="Shadow Wraith">
          </div>
          <div class="form-group">
            <label>Where Encountered</label>
            <input type="text" id="cr-location" placeholder="Dungeon, 3rd level">
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>Disposition</label>
            <select id="cr-hostile">
              <option value="Hostile">Hostile</option>
              <option value="Neutral">Neutral</option>
              <option value="Friendly">Friendly</option>
            </select>
          </div>
          <div class="form-group">
            <label>Survived? (Party)</label>
            <select id="cr-survived">
              <option value="Yes">Yes</option>
              <option value="No ‚Äî total party kill">No ‚Äî TPK</option>
              <option value="Fled">Fled</option>
              <option value="Negotiated">Negotiated</option>
            </select>
          </div>
        </div>
        <div class="form-group">
          <label>Observed Abilities</label>
          <textarea id="cr-abilities" placeholder="What it did in combat ‚Äî spells, special moves‚Ä¶"></textarea>
        </div>
        <div class="form-group">
          <label>Weaknesses Discovered</label>
          <textarea id="cr-weaknesses" placeholder="Fire damage, sunlight, holy water‚Ä¶"></textarea>
        </div>
        <div class="form-group">
          <label>Tactical Notes</label>
          <textarea id="cr-tactics" placeholder="How to fight it next time‚Ä¶"></textarea>
        </div>
        <div class="form-group">
          <label>Outcome / Story Result</label>
          <textarea id="cr-outcome" placeholder="Killed, captured, it escaped‚Ä¶"></textarea>
        </div>
        <div class="form-group">
          <label>Tags</label>
          <input type="text" id="cr-tags" placeholder="#undead, #boss, #recurring">
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-ghost" onclick="closeModal('modal-creature')">Cancel</button>
      <button class="btn btn-accent" onclick="saveCreature()">Save Creature</button>
    </div>
  </div>
</div>

<!-- LOCATION MODAL -->
<div class="modal-overlay" id="modal-location">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title" id="location-modal-title">Add Location</div>
      <button class="modal-close" onclick="closeModal('modal-location')">√ó</button>
    </div>
    <div class="modal-body">
      <div class="form-grid">
        <div class="form-row">
          <div class="form-group">
            <label>Name</label>
            <input type="text" id="l-name" placeholder="Barovia Village">
          </div>
          <div class="form-group">
            <label>Mood / Atmosphere</label>
            <input type="text" id="l-mood" placeholder="Oppressive, foggy, medieval">
          </div>
        </div>
        <div class="form-group">
          <label>Description (as experienced)</label>
          <textarea id="l-desc" placeholder="What the party saw, heard, smelled‚Ä¶" style="min-height:80px"></textarea>
        </div>
        <div class="form-group">
          <label>Notable Residents</label>
          <textarea id="l-residents" placeholder="Who lives there, who rules it‚Ä¶"></textarea>
        </div>
        <div class="form-group">
          <label>Shops & Services</label>
          <textarea id="l-shops" placeholder="Blacksmith, tavern, temple, market‚Ä¶"></textarea>
        </div>
        <div class="form-group">
          <label>Rumors Heard Here</label>
          <textarea id="l-rumors" placeholder="What the locals say‚Ä¶"></textarea>
        </div>
        <div class="form-group">
          <label>Events That Happened Here</label>
          <textarea id="l-events" placeholder="Fights, discoveries, key scenes‚Ä¶"></textarea>
        </div>
        <div class="form-group">
          <label>What We Changed Here</label>
          <textarea id="l-changed" placeholder="Did we anger guards? Kill a noble? Start a revolution?"></textarea>
        </div>
        <div class="form-group">
          <label>Tags</label>
          <input type="text" id="l-tags" placeholder="#city, #dungeon, #cursed">
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-ghost" onclick="closeModal('modal-location')">Cancel</button>
      <button class="btn btn-accent" onclick="saveLocation()">Save Location</button>
    </div>
  </div>
</div>

<!-- QUEST MODAL -->
<div class="modal-overlay" id="modal-quest">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title" id="quest-modal-title">Add Quest</div>
      <button class="modal-close" onclick="closeModal('modal-quest')">√ó</button>
    </div>
    <div class="modal-body">
      <div class="form-grid">
        <div class="form-row">
          <div class="form-group">
            <label>Quest Title</label>
            <input type="text" id="q-title" placeholder="Find the Lost Crown">
          </div>
          <div class="form-group">
            <label>Type</label>
            <select id="q-type">
              <option value="Main Story">üß≠ Main Story</option>
              <option value="Side Quest">üåø Side Quest</option>
              <option value="Personal Goal">üßë Personal Goal</option>
              <option value="Mystery">üß© Long-Term Mystery</option>
            </select>
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>Priority</label>
            <select id="q-priority">
              <option value="Critical">üî¥ Critical</option>
              <option value="High">üü† High</option>
              <option value="Medium" selected>üü° Medium</option>
              <option value="Low">üü¢ Low</option>
            </select>
          </div>
          <div class="form-group">
            <label>Risk Level</label>
            <select id="q-risk">
              <option value="Lethal">Lethal</option>
              <option value="Dangerous">Dangerous</option>
              <option value="Moderate" selected>Moderate</option>
              <option value="Safe">Safe</option>
            </select>
          </div>
        </div>
        <div class="form-group">
          <label>Objective ‚Äî What Are We Trying To Do?</label>
          <textarea id="q-objective" placeholder="Clear description of the goal‚Ä¶"></textarea>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>Quest Giver</label>
            <input type="text" id="q-giver" placeholder="Who gave it to us?">
          </div>
          <div class="form-group">
            <label>Reward</label>
            <input type="text" id="q-reward" placeholder="500gp, favor, info‚Ä¶">
          </div>
        </div>
        <div class="form-group">
          <label>Deadline (if known)</label>
          <input type="text" id="q-deadline" placeholder="Before the new moon‚Ä¶">
        </div>
        <div class="form-group">
          <label>Are We Actually Going To Do It?</label>
          <select id="q-intent">
            <option value="Yes">Yes ‚Äî on it</option>
            <option value="Maybe">Maybe</option>
            <option value="No">Probably not</option>
            <option value="Unknown">Unknown</option>
          </select>
        </div>
        <div class="form-group">
          <label>Status</label>
          <select id="q-status">
            <option value="Active">Active</option>
            <option value="Completed">Completed</option>
            <option value="Failed">Failed</option>
            <option value="On Hold">On Hold</option>
          </select>
        </div>
        <div class="form-group">
          <label>Tags</label>
          <input type="text" id="q-tags" placeholder="#artifact, #royalty">
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-ghost" onclick="closeModal('modal-quest')">Cancel</button>
      <button class="btn btn-accent" onclick="saveQuest()">Save Quest</button>
    </div>
  </div>
</div>

<!-- INVENTORY ITEM MODAL -->
<div class="modal-overlay" id="modal-item">
  <div class="modal" style="max-width:480px">
    <div class="modal-header">
      <div class="modal-title" id="item-modal-title">Add Item</div>
      <button class="modal-close" onclick="closeModal('modal-item')">√ó</button>
    </div>
    <div class="modal-body">
      <div class="form-grid">
        <div class="form-group">
          <label>Item Name</label>
          <input type="text" id="i-name" placeholder="Potion of Healing">
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>Category</label>
            <select id="i-category">
              <option value="Potion">Potion</option>
              <option value="Weapon">Weapon</option>
              <option value="Armor">Armor</option>
              <option value="Scroll">Scroll</option>
              <option value="Quest Item">Quest Item</option>
              <option value="Gem / Treasure">Gem / Treasure</option>
              <option value="Currency">Currency</option>
              <option value="Misc">Misc</option>
            </select>
          </div>
          <div class="form-group">
            <label>Quantity</label>
            <input type="number" id="i-qty" value="1" min="1">
          </div>
        </div>
        <div class="form-group">
          <label>Carried By</label>
          <input type="text" id="i-carrier" placeholder="Party / specific character">
        </div>
        <div class="form-group">
          <label>Attuned By</label>
          <input type="text" id="i-attuned" placeholder="Character name (if attuned)">
        </div>
        <div class="form-group">
          <label>Notes</label>
          <textarea id="i-notes" placeholder="Description, effects, value‚Ä¶"></textarea>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-ghost" onclick="closeModal('modal-item')">Cancel</button>
      <button class="btn btn-accent" onclick="saveItem()">Save Item</button>
    </div>
  </div>
</div>

<!-- THEORY MODAL -->
<div class="modal-overlay" id="modal-theory">
  <div class="modal" style="max-width:520px">
    <div class="modal-header">
      <div class="modal-title" id="theory-modal-title">Add Theory</div>
      <button class="modal-close" onclick="closeModal('modal-theory')">√ó</button>
    </div>
    <div class="modal-body">
      <div class="form-grid">
        <div class="form-group">
          <label>Theory Title</label>
          <input type="text" id="th-title" placeholder="The Duke is the actual villain">
        </div>
        <div class="form-group">
          <label>Category</label>
          <select id="th-category">
            <option value="Villain Theory">Villain Theory</option>
            <option value="Identity">Secret Identity</option>
            <option value="Conspiracy">Conspiracy</option>
            <option value="Timeline">Timeline</option>
            <option value="Prophecy">Prophecy</option>
            <option value="Other">Other</option>
          </select>
        </div>
        <div class="form-group">
          <label>The Theory</label>
          <textarea id="th-theory" placeholder="Detail your speculation‚Ä¶" style="min-height:100px"></textarea>
        </div>
        <div class="form-group">
          <label>Supporting Evidence</label>
          <textarea id="th-evidence" placeholder="Facts, clues, and observations that support this‚Ä¶"></textarea>
        </div>
        <div class="form-group">
          <label>Confidence Level</label>
          <select id="th-confidence">
            <option value="Wild Guess">üé≤ Wild Guess</option>
            <option value="Plausible" selected>ü§î Plausible</option>
            <option value="Likely">üßê Likely</option>
            <option value="Almost Certain">üî• Almost Certain</option>
            <option value="Confirmed">‚úÖ Confirmed</option>
          </select>
        </div>
        <div class="form-group">
          <label>Tags</label>
          <input type="text" id="th-tags" placeholder="#villain, #cult, #royalty">
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-ghost" onclick="closeModal('modal-theory')">Cancel</button>
      <button class="btn btn-accent" onclick="saveTheory()">Save Theory</button>
    </div>
  </div>
</div>

<!-- PARTY RELATIONSHIP MODAL -->
<div class="modal-overlay" id="modal-party">
  <div class="modal" style="max-width:480px">
    <div class="modal-header">
      <div class="modal-title" id="party-modal-title">Add Relationship</div>
      <button class="modal-close" onclick="closeModal('modal-party')">√ó</button>
    </div>
    <div class="modal-body">
      <div class="form-grid">
        <div class="form-row">
          <div class="form-group">
            <label>Character A</label>
            <input type="text" id="p-char-a" placeholder="Gimli">
          </div>
          <div class="form-group">
            <label>Character B</label>
            <input type="text" id="p-char-b" placeholder="Legolas">
          </div>
        </div>
        <div class="form-group">
          <label>Relationship Type</label>
          <select id="p-type">
            <option value="Bond">üíõ Bond / Friendship</option>
            <option value="Rivalry">‚ö° Rivalry</option>
            <option value="Romance">‚ù§Ô∏è Romance</option>
            <option value="Conflict">üî• Conflict</option>
            <option value="Debt">üí∞ Debt / Obligation</option>
            <option value="Secret">ü§´ Shared Secret</option>
            <option value="Mentor">üìö Mentor / Student</option>
          </select>
        </div>
        <div class="form-group">
          <label>Description</label>
          <textarea id="p-desc" placeholder="How did this relationship form? Where does it stand now?"></textarea>
        </div>
        <div class="form-group">
          <label>Shared Secrets / Tensions</label>
          <textarea id="p-secrets" placeholder="What does one know that the other doesn't?"></textarea>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-ghost" onclick="closeModal('modal-party')">Cancel</button>
      <button class="btn btn-accent" onclick="saveParty()">Save Relationship</button>
    </div>
  </div>
</div>

<!-- MEMORY MODAL -->
<div class="modal-overlay" id="modal-memory">
  <div class="modal" style="max-width:480px">
    <div class="modal-header">
      <div class="modal-title" id="memory-modal-title">Add Memory</div>
      <button class="modal-close" onclick="closeModal('modal-memory')">√ó</button>
    </div>
    <div class="modal-body">
      <div class="form-grid">
        <div class="form-group">
          <label>Type</label>
          <select id="m-type">
            <option value="Quote">üí¨ Funny Quote</option>
            <option value="Combat">‚öîÔ∏è Iconic Combat Moment</option>
            <option value="Inside Joke">üòÇ Inside Joke</option>
            <option value="Death Save">üíÄ Death Save</option>
            <option value="Critical Hit">üéØ Critical Hit</option>
            <option value="Achievement">üèÜ Achievement</option>
            <option value="Other">‚ú® Other</option>
          </select>
        </div>
        <div class="form-group">
          <label>Title / Label</label>
          <input type="text" id="m-title" placeholder="The Great Goblin Fumble">
        </div>
        <div class="form-group">
          <label>Description</label>
          <textarea id="m-desc" placeholder="Tell the story‚Ä¶"></textarea>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>Attributed To</label>
            <input type="text" id="m-attr" placeholder="Character or player name">
          </div>
          <div class="form-group">
            <label>Session #</label>
            <input type="number" id="m-session" placeholder="5" min="1">
          </div>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-ghost" onclick="closeModal('modal-memory')">Cancel</button>
      <button class="btn btn-accent" onclick="saveMemory()">Save Memory</button>
    </div>
  </div>
</div>

<!-- REPUTATION MODAL -->
<div class="modal-overlay" id="modal-reputation">
  <div class="modal" style="max-width:480px">
    <div class="modal-header">
      <div class="modal-title" id="rep-modal-title">Add Faction</div>
      <button class="modal-close" onclick="closeModal('modal-reputation')">√ó</button>
    </div>
    <div class="modal-body">
      <div class="form-grid">
        <div class="form-group">
          <label>Faction Name</label>
          <input type="text" id="r-name" placeholder="The Order of the Radiant Sun">
        </div>
        <div class="form-group">
          <label>Description</label>
          <textarea id="r-desc" placeholder="Who are they? What do they want?"></textarea>
        </div>
        <div class="form-group">
          <label>Reputation Score (0‚Äì100)</label>
          <input type="number" id="r-score" value="50" min="0" max="100">
        </div>
        <div class="form-group">
          <label>Notes on Current Standing</label>
          <textarea id="r-notes" placeholder="What happened to change our standing‚Ä¶"></textarea>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-ghost" onclick="closeModal('modal-reputation')">Cancel</button>
      <button class="btn btn-accent" onclick="saveReputation()">Save Faction</button>
    </div>
  </div>
</div>

<!-- DETAIL VIEW MODAL -->
<div class="modal-overlay" id="modal-detail">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title" id="detail-modal-title">Detail</div>
      <button class="modal-close" onclick="closeModal('modal-detail')">√ó</button>
    </div>
    <div class="modal-body" id="detail-modal-body"></div>
    <div class="modal-footer" id="detail-modal-footer">
      <button class="btn btn-ghost" onclick="closeModal('modal-detail')">Close</button>
    </div>
  </div>
</div>

<script type="module">
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  GITHUB API LAYER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

import { t1 } from './setting1.js';
import { t2 } from './setting2.js';
const encodedToken = t1 + t2;

let GH = {
  owner: 'teituroli',
  repo: 'chronicles',
  branch: 'main',
  token:  encodedToken
};

function setStatus(state, text) {
  const dot = document.getElementById('sync-dot');
  const txt = document.getElementById('sync-text');
  dot.className = 'status-dot ' + state;
  txt.textContent = text;
}

async function ghGet(path) {
  const res = await fetch(`https://api.github.com/repos/${GH.owner}/${GH.repo}/contents/${path}`, {
    headers: { Authorization: `token ${GH.token}`, Accept: 'application/vnd.github.v3+json' }
  });
  return res;
}

async function ghPut(path, content, message, sha = null) {
  const body = { message, content: btoa(unescape(encodeURIComponent(content))), branch: GH.branch };
  if (sha) body.sha = sha;
  return fetch(`https://api.github.com/repos/${GH.owner}/${GH.repo}/contents/${path}`, {
    method: 'PUT',
    headers: {
      Authorization: `token ${GH.token}`,
      Accept: 'application/vnd.github.v3+json',
      'Content-Type': 'application/json'
    },
    body: JSON.stringify(body)
  });
}

async function ghDelete(path, sha, message) {
  return fetch(`https://api.github.com/repos/${GH.owner}/${GH.repo}/contents/${path}`, {
    method: 'DELETE',
    headers: {
      Authorization: `token ${GH.token}`,
      Accept: 'application/vnd.github.v3+json',
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({ message, sha, branch: GH.branch })
  });
}

// Read a JSON file from repo, returns { data, sha } or { data: null, sha: null }
async function readJSON(path) {
  try {
    const res = await ghGet(path);
    if (!res.ok) return { data: null, sha: null };
    const json = await res.json();
    const data = JSON.parse(atob(json.content.replace(/\n/g, '')));
    return { data, sha: json.sha };
  } catch {
    return { data: null, sha: null };
  }
}

// Write a JSON file to repo
async function writeJSON(path, data, message) {
  setStatus('loading', 'Saving‚Ä¶');
  try {
    const { sha } = await readJSON(path);
    const res = await ghPut(path, JSON.stringify(data, null, 2), message, sha);
    if (res.ok) {
      setStatus('ok', 'Saved');
      setTimeout(() => setStatus('ok', 'Connected'), 2000);
    } else {
      const err = await res.json();
      setStatus('err', 'Save failed: ' + (err.message || res.status));
    }
    return res.ok;
  } catch (e) {
    setStatus('err', 'Error: ' + e.message);
    return false;
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  STATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

let state = {
  campaigns: [],       // array of {id, name, system, party, desc, created}
  currentCampaign: null,
  data: {
    sessions: [],
    npcs: [],
    creatures: [],
    locations: [],
    quests: [],
    inventory: [],
    theories: [],
    party: [],
    memory: [],
    reputation: []
  }
};

let editingId = {}; // track which id is being edited per type

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  SETTINGS / INIT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function loadSettings() {
  const saved = localStorage.getItem('chronicle_gh');
  if (saved) {
    GH = JSON.parse(saved);
    document.getElementById('s-owner').value = GH.owner || '';
    document.getElementById('s-repo').value = GH.repo || '';
    document.getElementById('s-branch').value = GH.branch || 'main';
    document.getElementById('s-token').value = GH.token || '';
  }
}

async function saveSettings() {
  GH.owner = document.getElementById('s-owner').value.trim();
  GH.repo = document.getElementById('s-repo').value.trim();
  GH.branch = document.getElementById('s-branch').value.trim() || 'main';
  GH.token = document.getElementById('s-token').value.trim();
  localStorage.setItem('chronicle_gh', JSON.stringify(GH));
  setStatus('loading', 'Testing‚Ä¶');

  if (!GH.owner || !GH.repo || !GH.token) {
    setStatus('err', 'Fill all fields');
    return;
  }

  const res = await fetch(`https://api.github.com/repos/${GH.owner}/${GH.repo}`, {
    headers: { Authorization: `token ${GH.token}` }
  });
  if (res.ok) {
    setStatus('ok', 'Connected');
    await loadCampaigns();
  } else {
    setStatus('err', 'Cannot reach repo');
  }
}

async function forceSyncAll() {
  await loadCampaigns();
  if (state.currentCampaign) await loadCampaignData(state.currentCampaign);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  CAMPAIGNS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

async function loadCampaigns() {
  if (!GH.owner || !GH.repo || !GH.token) return;
  setStatus('loading', 'Loading‚Ä¶');
  const { data } = await readJSON('campaigns.json');
  state.campaigns = data || [];
  renderCampaignSelect();
  setStatus('ok', 'Connected');

  // Auto-select last used
  const lastId = localStorage.getItem('chronicle_last_campaign');
  if (lastId && state.campaigns.find(c => c.id === lastId)) {
    document.getElementById('campaign-select').value = lastId;
    await selectCampaign(lastId);
  }
}

function renderCampaignSelect() {
  const sel = document.getElementById('campaign-select');
  sel.innerHTML = '<option value="">‚Äî Select Campaign ‚Äî</option>';
  state.campaigns.forEach(c => {
    const opt = document.createElement('option');
    opt.value = c.id;
    opt.textContent = c.name + (c.system ? ` (${c.system})` : '');
    sel.appendChild(opt);
  });
  if (state.currentCampaign) sel.value = state.currentCampaign;
}

document.getElementById('campaign-select').addEventListener('change', async function() {
  if (this.value) {
    await selectCampaign(this.value);
  } else {
    state.currentCampaign = null;
    document.getElementById('no-campaign').style.display = 'flex';
    document.getElementById('main').querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  }
});

async function selectCampaign(id) {
  state.currentCampaign = id;
  localStorage.setItem('chronicle_last_campaign', id);
  document.getElementById('no-campaign').style.display = 'none';
  document.getElementById('campaign-select').value = id;
  await loadCampaignData(id);
  showPage(document.querySelector('.nav-item.active')?.dataset.page || 'sessions');
}

async function loadCampaignData(id) {
  setStatus('loading', 'Loading campaign‚Ä¶');
  const keys = ['sessions','npcs','creatures','locations','quests','inventory','theories','party','memory','reputation'];
  for (const key of keys) {
    const { data } = await readJSON(`campaigns/${id}/${key}.json`);
    state.data[key] = data || [];
  }
  renderAll();
  setStatus('ok', 'Connected');
}

function openNewCampaignModal() {
  document.getElementById('c-name').value = '';
  document.getElementById('c-system').value = '';
  document.getElementById('c-party').value = '';
  document.getElementById('c-desc').value = '';
  openModal('modal-campaign');
}

async function createCampaign() {
  const name = document.getElementById('c-name').value.trim();
  if (!name) return alert('Campaign name required');

  const id = 'c_' + Date.now();
  const campaign = {
    id,
    name,
    system: document.getElementById('c-system').value.trim(),
    party: document.getElementById('c-party').value.trim(),
    desc: document.getElementById('c-desc').value.trim(),
    created: new Date().toISOString()
  };

  state.campaigns.push(campaign);
  await writeJSON('campaigns.json', state.campaigns, `Add campaign: ${name}`);

  // Init empty data files
  const keys = ['sessions','npcs','creatures','locations','quests','inventory','theories','party','memory','reputation'];
  for (const key of keys) {
    await writeJSON(`campaigns/${id}/${key}.json`, [], `Init ${key} for ${name}`);
  }

  renderCampaignSelect();
  closeModal('modal-campaign');
  await selectCampaign(id);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  NAVIGATION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function showPage(name) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
  const page = document.getElementById('page-' + name);
  if (page) page.classList.add('active');
  const nav = document.querySelector(`.nav-item[data-page="${name}"]`);
  if (nav) nav.classList.add('active');
  if (name === 'quests') renderQuests();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  MODAL HELPERS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function openModal(id) { document.getElementById(id).classList.add('open'); }
function closeModal(id) { document.getElementById(id).classList.remove('open'); }

document.querySelectorAll('.modal-overlay').forEach(overlay => {
  overlay.addEventListener('click', e => { if (e.target === overlay) overlay.classList.remove('open'); });
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  GENERIC CRUD HELPERS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function uid() { return 'id_' + Date.now() + '_' + Math.random().toString(36).slice(2, 7); }

async function saveData(key) {
  const id = state.currentCampaign;
  if (!id) return;
  return writeJSON(`campaigns/${id}/${key}.json`, state.data[key], `Update ${key}`);
}

function renderAll() {
  renderSessions();
  renderNPCs();
  renderCreatures();
  renderLocations();
  renderQuests();
  renderInventory();
  renderTheories();
  renderParty();
  renderMemory();
  renderReputation();
}

function tagsHTML(tags) {
  if (!tags) return '';
  return tags.split(',').map(t => t.trim()).filter(Boolean).map(t =>
    `<span class="tag">${t.startsWith('#') ? t : '#'+t}</span>`
  ).join('');
}

function trustStars(n) {
  return Array.from({length:5}, (_,i) =>
    `<span class="star ${i < n ? 'filled' : ''}">‚òÖ</span>`
  ).join('');
}

function emptyState(icon, title, sub, btnLabel, btnFn) {
  return `<div class="empty">
    <div class="empty-icon">${icon}</div>
    <div class="empty-title">${title}</div>
    <div class="empty-sub">${sub}</div>
    <button class="btn btn-ghost" onclick="${btnFn}" style="margin-top:8px">${btnLabel}</button>
  </div>`;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  SESSIONS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

let sessionFilter = '';

function filterSessions(v) {
  sessionFilter = v.toLowerCase();
  renderSessions();
}

function openSessionModal(id = null) {
  if (!state.currentCampaign) return alert('Select a campaign first');
  editingId.session = id;
  document.getElementById('session-modal-title').textContent = id ? 'Edit Session' : 'New Session';
  const s = id ? state.data.sessions.find(x => x.id === id) : null;
  const nextNum = (state.data.sessions.length > 0 ?
    Math.max(...state.data.sessions.map(s => s.num || 0)) + 1 : 1);
  document.getElementById('s-num').value = s?.num ?? nextNum;
  document.getElementById('s-date').value = s?.date ?? '';
  document.getElementById('s-location').value = s?.location ?? '';
  document.getElementById('s-present').value = s?.present ?? '';
  document.getElementById('s-narrative').value = s?.narrative ?? '';
  document.getElementById('s-discoveries').value = s?.discoveries ?? '';
  document.getElementById('s-npcs').value = s?.npcs ?? '';
  document.getElementById('s-creatures').value = s?.creatures ?? '';
  document.getElementById('s-loot').value = s?.loot ?? '';
  document.getElementById('s-questions').value = s?.questions ?? '';
  document.getElementById('s-tags').value = s?.tags ?? '';
  openModal('modal-session');
}

async function saveSession() {
  const id = editingId.session;
  const obj = {
    id: id || uid(),
    num: parseInt(document.getElementById('s-num').value) || 0,
    date: document.getElementById('s-date').value.trim(),
    location: document.getElementById('s-location').value.trim(),
    present: document.getElementById('s-present').value.trim(),
    narrative: document.getElementById('s-narrative').value.trim(),
    discoveries: document.getElementById('s-discoveries').value.trim(),
    npcs: document.getElementById('s-npcs').value.trim(),
    creatures: document.getElementById('s-creatures').value.trim(),
    loot: document.getElementById('s-loot').value.trim(),
    questions: document.getElementById('s-questions').value.trim(),
    tags: document.getElementById('s-tags').value.trim(),
    created: id ? (state.data.sessions.find(x => x.id === id)?.created || new Date().toISOString()) : new Date().toISOString()
  };

  if (id) {
    const idx = state.data.sessions.findIndex(x => x.id === id);
    state.data.sessions[idx] = obj;
  } else {
    state.data.sessions.push(obj);
  }

  state.data.sessions.sort((a, b) => b.num - a.num);
  await saveData('sessions');
  closeModal('modal-session');
  renderSessions();
}

async function deleteSession(id) {
  if (!confirm('Delete this session?')) return;
  state.data.sessions = state.data.sessions.filter(x => x.id !== id);
  await saveData('sessions');
  renderSessions();
}

function viewSession(id) {
  const s = state.data.sessions.find(x => x.id === id);
  if (!s) return;
  document.getElementById('detail-modal-title').textContent = `Session #${s.num}`;

  function section(icon, label, content) {
    if (!content) return '';
    return `<div class="detail-section">
      <div class="detail-label">${icon} ${label}</div>
      <div class="detail-value">${escHtml(content)}</div>
    </div>`;
  }

  document.getElementById('detail-modal-body').innerHTML = `
    <div style="display:flex;gap:12px;margin-bottom:16px;flex-wrap:wrap">
      <span class="badge badge-yellow">Session #${s.num}</span>
      ${s.date ? `<span class="badge badge-gray">${escHtml(s.date)}</span>` : ''}
      ${s.location ? `<span class="badge badge-purple">üìç ${escHtml(s.location)}</span>` : ''}
      ${s.present ? `<span class="badge badge-green">üë• ${escHtml(s.present)}</span>` : ''}
    </div>
    ${section('üìù','What Happened', s.narrative)}
    ${section('üß†','Discoveries', s.discoveries)}
    ${section('üë•','NPCs Met', s.npcs)}
    ${section('üëπ','Creatures', s.creatures)}
    ${section('üí∞','Loot', s.loot)}
    ${section('‚ùì','Unanswered Questions', s.questions)}
    ${s.tags ? `<div class="detail-section"><div class="detail-label">Tags</div><div>${tagsHTML(s.tags)}</div></div>` : ''}
  `;

  document.getElementById('detail-modal-footer').innerHTML = `
    <button class="btn btn-ghost" onclick="closeModal('modal-detail')">Close</button>
    <button class="btn btn-ghost" onclick="closeModal('modal-detail');openSessionModal('${id}')">Edit</button>
    <button class="btn btn-danger" onclick="closeModal('modal-detail');deleteSession('${id}')">Delete</button>
  `;
  openModal('modal-detail');
}

function renderSessions() {
  const el = document.getElementById('sessions-list');
  let sessions = state.data.sessions;
  if (sessionFilter) {
    sessions = sessions.filter(s =>
      (s.narrative||'').toLowerCase().includes(sessionFilter) ||
      (s.location||'').toLowerCase().includes(sessionFilter) ||
      (s.tags||'').toLowerCase().includes(sessionFilter)
    );
  }

  if (!sessions.length) {
    el.innerHTML = emptyState('üìñ','No sessions yet','Start logging your first session','+ New Session','openSessionModal()');
    return;
  }

  el.innerHTML = sessions.map(s => `
    <div class="card" onclick="viewSession('${s.id}')">
      <div class="card-top">
        <div>
          <div class="card-title">Session #${s.num}</div>
          <div class="card-meta">${s.date || 'No in-game date'} ‚Ä¢ ${s.location || 'Unknown location'}</div>
        </div>
        <span class="badge badge-purple">#${s.num}</span>
      </div>
      <div class="card-body">${escHtml((s.narrative||'').slice(0,160))}${(s.narrative||'').length > 160 ? '‚Ä¶' : ''}</div>
      ${s.tags ? `<div style="margin-top:8px">${tagsHTML(s.tags)}</div>` : ''}
      <div class="card-actions">
        <button class="btn btn-ghost" onclick="event.stopPropagation();openSessionModal('${s.id}')">Edit</button>
        <button class="btn btn-danger" onclick="event.stopPropagation();deleteSession('${s.id}')">Delete</button>
      </div>
    </div>
  `).join('');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  NPCs
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

let npcFilter = '';

function filterNPCs(v) {
  npcFilter = v.toLowerCase();
  renderNPCs();
}

function openNPCModal(id = null) {
  if (!state.currentCampaign) return alert('Select a campaign first');
  editingId.npc = id;
  document.getElementById('npc-modal-title').textContent = id ? 'Edit NPC' : 'Add NPC';
  const n = id ? state.data.npcs.find(x => x.id === id) : null;
  ['name','location','impression','wants','secrets','debts','quotes','suspicious','tags'].forEach(f => {
    document.getElementById('n-' + f).value = n?.[f] ?? '';
  });
  document.getElementById('n-trust').value = n?.trust ?? '3';
  document.getElementById('n-align').value = n?.align ?? 'Unknown';
  openModal('modal-npc');
}

async function saveNPC() {
  const id = editingId.npc;
  const obj = {
    id: id || uid(),
    name: document.getElementById('n-name').value.trim(),
    location: document.getElementById('n-location').value.trim(),
    trust: document.getElementById('n-trust').value,
    align: document.getElementById('n-align').value,
    impression: document.getElementById('n-impression').value.trim(),
    wants: document.getElementById('n-wants').value.trim(),
    secrets: document.getElementById('n-secrets').value.trim(),
    debts: document.getElementById('n-debts').value.trim(),
    quotes: document.getElementById('n-quotes').value.trim(),
    suspicious: document.getElementById('n-suspicious').value.trim(),
    tags: document.getElementById('n-tags').value.trim()
  };

  if (!obj.name) return alert('Name required');
  if (id) state.data.npcs[state.data.npcs.findIndex(x => x.id === id)] = obj;
  else state.data.npcs.push(obj);
  await saveData('npcs');
  closeModal('modal-npc');
  renderNPCs();
}

async function deleteNPC(id) {
  if (!confirm('Delete this NPC?')) return;
  state.data.npcs = state.data.npcs.filter(x => x.id !== id);
  await saveData('npcs');
  renderNPCs();
}

const alignBadge = { Ally:'badge-green', Neutral:'badge-gray', Rival:'badge-yellow', Threat:'badge-red', Unknown:'badge-purple' };

function renderNPCs() {
  const el = document.getElementById('npcs-list');
  const alignFilter = document.getElementById('npc-filter-align')?.value || '';
  let npcs = state.data.npcs;
  if (npcFilter) npcs = npcs.filter(n => (n.name||'').toLowerCase().includes(npcFilter) || (n.location||'').toLowerCase().includes(npcFilter));
  if (alignFilter) npcs = npcs.filter(n => n.align === alignFilter);

  if (!npcs.length) {
    el.innerHTML = emptyState('üë•','No NPCs tracked','Add the characters you\'ve met','+ Add NPC','openNPCModal()');
    return;
  }

  el.innerHTML = npcs.map(n => `
    <div class="card">
      <div class="card-top">
        <div>
          <div class="card-title">${escHtml(n.name)}</div>
          <div class="card-meta">üìç ${escHtml(n.location||'Unknown')}</div>
        </div>
        <span class="badge ${alignBadge[n.align]||'badge-gray'}">${n.align}</span>
      </div>
      <div class="trust-stars">${trustStars(parseInt(n.trust)||3)}</div>
      ${n.impression ? `<div class="card-body" style="margin-top:8px">${escHtml(n.impression.slice(0,120))}${n.impression.length>120?'‚Ä¶':''}</div>` : ''}
      ${n.quotes ? `<div class="quote-item" style="margin-top:10px"><div class="quote-text">${escHtml(n.quotes.split('\n')[0])}</div></div>` : ''}
      ${n.tags ? `<div style="margin-top:8px">${tagsHTML(n.tags)}</div>` : ''}
      <div class="card-actions">
        <button class="btn btn-ghost" onclick="openNPCModal('${n.id}')">Edit</button>
        <button class="btn btn-danger" onclick="deleteNPC('${n.id}')">Delete</button>
      </div>
    </div>
  `).join('');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  CREATURES
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function openCreatureModal(id = null) {
  if (!state.currentCampaign) return alert('Select a campaign first');
  editingId.creature = id;
  document.getElementById('creature-modal-title').textContent = id ? 'Edit Creature' : 'Add Creature';
  const c = id ? state.data.creatures.find(x => x.id === id) : null;
  ['name','location','abilities','weaknesses','tactics','outcome','tags'].forEach(f => {
    document.getElementById('cr-' + f).value = c?.[f] ?? '';
  });
  document.getElementById('cr-hostile').value = c?.hostile ?? 'Hostile';
  document.getElementById('cr-survived').value = c?.survived ?? 'Yes';
  openModal('modal-creature');
}

async function saveCreature() {
  const id = editingId.creature;
  const obj = {
    id: id || uid(),
    name: document.getElementById('cr-name').value.trim(),
    location: document.getElementById('cr-location').value.trim(),
    hostile: document.getElementById('cr-hostile').value,
    survived: document.getElementById('cr-survived').value,
    abilities: document.getElementById('cr-abilities').value.trim(),
    weaknesses: document.getElementById('cr-weaknesses').value.trim(),
    tactics: document.getElementById('cr-tactics').value.trim(),
    outcome: document.getElementById('cr-outcome').value.trim(),
    tags: document.getElementById('cr-tags').value.trim()
  };
  if (!obj.name) return alert('Name required');
  if (id) state.data.creatures[state.data.creatures.findIndex(x => x.id === id)] = obj;
  else state.data.creatures.push(obj);
  await saveData('creatures');
  closeModal('modal-creature');
  renderCreatures();
}

async function deleteCreature(id) {
  if (!confirm('Delete?')) return;
  state.data.creatures = state.data.creatures.filter(x => x.id !== id);
  await saveData('creatures');
  renderCreatures();
}

function filterCreatures(v) {
  state._creatureFilter = v.toLowerCase();
  renderCreatures();
}

function renderCreatures() {
  const el = document.getElementById('creatures-list');
  let items = state.data.creatures;
  const f = state._creatureFilter || '';
  if (f) items = items.filter(c => (c.name||'').toLowerCase().includes(f));

  if (!items.length) {
    el.innerHTML = emptyState('üëπ','Bestiary empty','Log creatures as you encounter them','+ Add Creature','openCreatureModal()');
    return;
  }

  const hostileColor = { Hostile:'badge-red', Neutral:'badge-yellow', Friendly:'badge-green' };
  el.innerHTML = items.map(c => `
    <div class="card">
      <div class="card-top">
        <div>
          <div class="card-title">${escHtml(c.name)}</div>
          <div class="card-meta">üìç ${escHtml(c.location||'Unknown')}</div>
        </div>
        <span class="badge ${hostileColor[c.hostile]||'badge-gray'}">${c.hostile}</span>
      </div>
      <div style="margin-bottom:8px"><span class="badge ${c.survived==='Yes'?'badge-green':'badge-red'}">${c.survived}</span></div>
      ${c.abilities ? `<div class="detail-label">Abilities</div><div class="card-body">${escHtml(c.abilities.slice(0,120))}‚Ä¶</div>` : ''}
      ${c.weaknesses ? `<div class="detail-label" style="margin-top:8px">Weaknesses</div><div class="card-body">${escHtml(c.weaknesses.slice(0,80))}‚Ä¶</div>` : ''}
      ${c.tags ? `<div style="margin-top:8px">${tagsHTML(c.tags)}</div>` : ''}
      <div class="card-actions">
        <button class="btn btn-ghost" onclick="openCreatureModal('${c.id}')">Edit</button>
        <button class="btn btn-danger" onclick="deleteCreature('${c.id}')">Delete</button>
      </div>
    </div>
  `).join('');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  LOCATIONS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function openLocationModal(id = null) {
  if (!state.currentCampaign) return alert('Select a campaign first');
  editingId.location = id;
  document.getElementById('location-modal-title').textContent = id ? 'Edit Location' : 'Add Location';
  const l = id ? state.data.locations.find(x => x.id === id) : null;
  ['name','mood','desc','residents','shops','rumors','events','changed','tags'].forEach(f => {
    document.getElementById('l-' + f).value = l?.[f] ?? '';
  });
  openModal('modal-location');
}

async function saveLocation() {
  const id = editingId.location;
  const obj = {
    id: id || uid(),
    name: document.getElementById('l-name').value.trim(),
    mood: document.getElementById('l-mood').value.trim(),
    desc: document.getElementById('l-desc').value.trim(),
    residents: document.getElementById('l-residents').value.trim(),
    shops: document.getElementById('l-shops').value.trim(),
    rumors: document.getElementById('l-rumors').value.trim(),
    events: document.getElementById('l-events').value.trim(),
    changed: document.getElementById('l-changed').value.trim(),
    tags: document.getElementById('l-tags').value.trim()
  };
  if (!obj.name) return alert('Name required');
  if (id) state.data.locations[state.data.locations.findIndex(x => x.id === id)] = obj;
  else state.data.locations.push(obj);
  await saveData('locations');
  closeModal('modal-location');
  renderLocations();
}

async function deleteLocation(id) {
  if (!confirm('Delete?')) return;
  state.data.locations = state.data.locations.filter(x => x.id !== id);
  await saveData('locations');
  renderLocations();
}

function filterLocations(v) {
  state._locFilter = v.toLowerCase();
  renderLocations();
}

function renderLocations() {
  const el = document.getElementById('locations-list');
  let items = state.data.locations;
  const f = state._locFilter || '';
  if (f) items = items.filter(l => (l.name||'').toLowerCase().includes(f) || (l.mood||'').toLowerCase().includes(f));

  if (!items.length) {
    el.innerHTML = emptyState('üó∫Ô∏è','No locations yet','Log towns, dungeons, and ruins','+ Add Location','openLocationModal()');
    return;
  }

  el.innerHTML = items.map(l => `
    <div class="card">
      <div class="card-top">
        <div>
          <div class="card-title">${escHtml(l.name)}</div>
          <div class="card-meta">${escHtml(l.mood||'')}</div>
        </div>
      </div>
      ${l.desc ? `<div class="card-body">${escHtml(l.desc.slice(0,140))}${l.desc.length>140?'‚Ä¶':''}</div>` : ''}
      ${l.changed ? `<div class="card-body" style="margin-top:6px;color:var(--accent3)">‚ö° ${escHtml(l.changed.slice(0,80))}‚Ä¶</div>` : ''}
      ${l.tags ? `<div style="margin-top:8px">${tagsHTML(l.tags)}</div>` : ''}
      <div class="card-actions">
        <button class="btn btn-ghost" onclick="openLocationModal('${l.id}')">Edit</button>
        <button class="btn btn-danger" onclick="deleteLocation('${l.id}')">Delete</button>
      </div>
    </div>
  `).join('');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  QUESTS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function openQuestModal(id = null) {
  if (!state.currentCampaign) return alert('Select a campaign first');
  editingId.quest = id;
  document.getElementById('quest-modal-title').textContent = id ? 'Edit Quest' : 'Add Quest';
  const q = id ? state.data.quests.find(x => x.id === id) : null;
  ['title','giver','reward','deadline','objective','tags'].forEach(f => {
    document.getElementById('q-' + f).value = q?.[f] ?? '';
  });
  document.getElementById('q-type').value = q?.type ?? 'Main Story';
  document.getElementById('q-priority').value = q?.priority ?? 'Medium';
  document.getElementById('q-risk').value = q?.risk ?? 'Moderate';
  document.getElementById('q-intent').value = q?.intent ?? 'Yes';
  document.getElementById('q-status').value = q?.status ?? 'Active';
  openModal('modal-quest');
}

async function saveQuest() {
  const id = editingId.quest;
  const obj = {
    id: id || uid(),
    title: document.getElementById('q-title').value.trim(),
    type: document.getElementById('q-type').value,
    priority: document.getElementById('q-priority').value,
    risk: document.getElementById('q-risk').value,
    objective: document.getElementById('q-objective').value.trim(),
    giver: document.getElementById('q-giver').value.trim(),
    reward: document.getElementById('q-reward').value.trim(),
    deadline: document.getElementById('q-deadline').value.trim(),
    intent: document.getElementById('q-intent').value,
    status: document.getElementById('q-status').value,
    tags: document.getElementById('q-tags').value.trim()
  };
  if (!obj.title) return alert('Title required');
  if (id) state.data.quests[state.data.quests.findIndex(x => x.id === id)] = obj;
  else state.data.quests.push(obj);
  await saveData('quests');
  closeModal('modal-quest');
  renderQuests();
}

async function deleteQuest(id) {
  if (!confirm('Delete?')) return;
  state.data.quests = state.data.quests.filter(x => x.id !== id);
  await saveData('quests');
  renderQuests();
}

function renderQuests() {
  const el = document.getElementById('quests-board');
  const columns = [
    { type: 'Main Story', icon: 'üß≠', label: 'Main Story' },
    { type: 'Side Quest', icon: 'üåø', label: 'Side Quests' },
    { type: 'Personal Goal', icon: 'üßë', label: 'Personal Goals' },
    { type: 'Mystery', icon: 'üß©', label: 'Mysteries' }
  ];

  if (!state.data.quests.length) {
    el.innerHTML = emptyState('üéØ','Quest board empty','Track your objectives and leads','+ Add Quest','openQuestModal()');
    return;
  }

  const priorityColor = { Critical:'badge-red', High:'badge-yellow', Medium:'badge-purple', Low:'badge-green' };

  el.innerHTML = columns.map(col => {
    const qs = state.data.quests.filter(q => q.type === col.type);
    return `<div class="quest-column">
      <div class="quest-column-title">${col.icon} ${col.label} <span class="badge badge-gray" style="margin-left:auto">${qs.length}</span></div>
      ${qs.length ? qs.map(q => `
        <div class="quest-item" onclick="openQuestModal('${q.id}')">
          <div style="display:flex;gap:6px;align-items:flex-start;justify-content:space-between">
            <div class="quest-item-title">${escHtml(q.title)}</div>
            <span class="badge ${priorityColor[q.priority]||'badge-gray'}">${q.priority}</span>
          </div>
          ${q.giver ? `<div class="card-meta">From: ${escHtml(q.giver)}</div>` : ''}
          ${q.reward ? `<div class="card-meta">üí∞ ${escHtml(q.reward)}</div>` : ''}
          <div style="display:flex;gap:6px;margin-top:8px;justify-content:space-between;align-items:center">
            <span class="badge badge-gray">${q.status}</span>
            <button class="btn btn-danger" style="padding:2px 8px;font-size:10px" onclick="event.stopPropagation();deleteQuest('${q.id}')">‚úï</button>
          </div>
        </div>
      `).join('') : `<div style="color:var(--text3);font-size:12px;text-align:center;padding:12px">None</div>`}
    </div>`;
  }).join('');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  INVENTORY
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function openItemModal(id = null) {
  if (!state.currentCampaign) return alert('Select a campaign first');
  editingId.item = id;
  document.getElementById('item-modal-title').textContent = id ? 'Edit Item' : 'Add Item';
  const item = id ? state.data.inventory.find(x => x.id === id) : null;
  document.getElementById('i-name').value = item?.name ?? '';
  document.getElementById('i-category').value = item?.category ?? 'Misc';
  document.getElementById('i-qty').value = item?.qty ?? 1;
  document.getElementById('i-carrier').value = item?.carrier ?? '';
  document.getElementById('i-attuned').value = item?.attuned ?? '';
  document.getElementById('i-notes').value = item?.notes ?? '';
  openModal('modal-item');
}

async function saveItem() {
  const id = editingId.item;
  const obj = {
    id: id || uid(),
    name: document.getElementById('i-name').value.trim(),
    category: document.getElementById('i-category').value,
    qty: parseInt(document.getElementById('i-qty').value) || 1,
    carrier: document.getElementById('i-carrier').value.trim(),
    attuned: document.getElementById('i-attuned').value.trim(),
    notes: document.getElementById('i-notes').value.trim()
  };
  if (!obj.name) return alert('Name required');
  if (id) state.data.inventory[state.data.inventory.findIndex(x => x.id === id)] = obj;
  else state.data.inventory.push(obj);
  await saveData('inventory');
  closeModal('modal-item');
  renderInventory();
}

async function deleteItem(id) {
  if (!confirm('Delete?')) return;
  state.data.inventory = state.data.inventory.filter(x => x.id !== id);
  await saveData('inventory');
  renderInventory();
}

function renderInventory() {
  const el = document.getElementById('inventory-body');
  if (!state.data.inventory.length) {
    el.innerHTML = emptyState('üéí','Empty packs','Track your party\'s equipment and loot','+ Add Item','openItemModal()');
    return;
  }

  const categories = [...new Set(state.data.inventory.map(i => i.category))].sort();

  el.innerHTML = categories.map(cat => {
    const items = state.data.inventory.filter(i => i.category === cat);
    return `<div class="inventory-section">
      <div class="section-title">${cat} (${items.length})</div>
      <table class="inventory-table">
        <thead><tr>
          <th>Item</th><th>Qty</th><th>Carrier</th><th>Attuned</th><th>Notes</th><th></th>
        </tr></thead>
        <tbody>${items.map(item => `<tr>
          <td style="color:var(--text)">${escHtml(item.name)}</td>
          <td>${item.qty}</td>
          <td>${escHtml(item.carrier||'Party')}</td>
          <td>${escHtml(item.attuned||'‚Äî')}</td>
          <td>${escHtml((item.notes||'').slice(0,60))}</td>
          <td>
            <button class="btn btn-ghost" style="padding:2px 8px;font-size:10px" onclick="openItemModal('${item.id}')">Edit</button>
            <button class="btn btn-danger" style="padding:2px 8px;font-size:10px" onclick="deleteItem('${item.id}')">‚úï</button>
          </td>
        </tr>`).join('')}</tbody>
      </table>
    </div>`;
  }).join('');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  THEORIES
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function openTheoryModal(id = null) {
  if (!state.currentCampaign) return alert('Select a campaign first');
  editingId.theory = id;
  document.getElementById('theory-modal-title').textContent = id ? 'Edit Theory' : 'Add Theory';
  const t = id ? state.data.theories.find(x => x.id === id) : null;
  ['title','theory','evidence','tags'].forEach(f => { document.getElementById('th-' + f).value = t?.[f] ?? ''; });
  document.getElementById('th-category').value = t?.category ?? 'Villain Theory';
  document.getElementById('th-confidence').value = t?.confidence ?? 'Plausible';
  openModal('modal-theory');
}

async function saveTheory() {
  const id = editingId.theory;
  const obj = {
    id: id || uid(),
    title: document.getElementById('th-title').value.trim(),
    category: document.getElementById('th-category').value,
    theory: document.getElementById('th-theory').value.trim(),
    evidence: document.getElementById('th-evidence').value.trim(),
    confidence: document.getElementById('th-confidence').value,
    tags: document.getElementById('th-tags').value.trim()
  };
  if (!obj.title) return alert('Title required');
  if (id) state.data.theories[state.data.theories.findIndex(x => x.id === id)] = obj;
  else state.data.theories.push(obj);
  await saveData('theories');
  closeModal('modal-theory');
  renderTheories();
}

async function deleteTheory(id) {
  if (!confirm('Delete?')) return;
  state.data.theories = state.data.theories.filter(x => x.id !== id);
  await saveData('theories');
  renderTheories();
}

const confidenceColor = { 'Wild Guess':'badge-gray','Plausible':'badge-purple','Likely':'badge-yellow','Almost Certain':'badge-yellow','Confirmed':'badge-green' };

function renderTheories() {
  const el = document.getElementById('theories-list');
  if (!state.data.theories.length) {
    el.innerHTML = emptyState('üß†','No theories yet','Document your suspicions and conspiracies','+ Add Theory','openTheoryModal()');
    return;
  }

  el.innerHTML = state.data.theories.map(t => `
    <div class="theory-item">
      <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:8px">
        <div>
          <div class="card-title">${escHtml(t.title)}</div>
          <div class="card-meta">${t.category}</div>
        </div>
        <span class="badge ${confidenceColor[t.confidence]||'badge-gray'}">${t.confidence}</span>
      </div>
      ${t.theory ? `<div class="detail-label">Theory</div><div class="card-body">${escHtml(t.theory)}</div>` : ''}
      ${t.evidence ? `<div class="detail-label" style="margin-top:10px">Evidence</div><div class="card-body">${escHtml(t.evidence)}</div>` : ''}
      ${t.tags ? `<div style="margin-top:8px">${tagsHTML(t.tags)}</div>` : ''}
      <div class="card-actions" style="border-top:1px solid var(--border);margin-top:12px;padding-top:10px">
        <button class="btn btn-ghost" onclick="openTheoryModal('${t.id}')">Edit</button>
        <button class="btn btn-danger" onclick="deleteTheory('${t.id}')">Delete</button>
      </div>
    </div>
  `).join('');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  PARTY RELATIONSHIPS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function openPartyModal(id = null) {
  if (!state.currentCampaign) return alert('Select a campaign first');
  editingId.party = id;
  document.getElementById('party-modal-title').textContent = id ? 'Edit Relationship' : 'Add Relationship';
  const p = id ? state.data.party.find(x => x.id === id) : null;
  document.getElementById('p-char-a').value = p?.charA ?? '';
  document.getElementById('p-char-b').value = p?.charB ?? '';
  document.getElementById('p-type').value = p?.type ?? 'Bond';
  document.getElementById('p-desc').value = p?.desc ?? '';
  document.getElementById('p-secrets').value = p?.secrets ?? '';
  openModal('modal-party');
}

async function saveParty() {
  const id = editingId.party;
  const obj = {
    id: id || uid(),
    charA: document.getElementById('p-char-a').value.trim(),
    charB: document.getElementById('p-char-b').value.trim(),
    type: document.getElementById('p-type').value,
    desc: document.getElementById('p-desc').value.trim(),
    secrets: document.getElementById('p-secrets').value.trim()
  };
  if (!obj.charA || !obj.charB) return alert('Both characters required');
  if (id) state.data.party[state.data.party.findIndex(x => x.id === id)] = obj;
  else state.data.party.push(obj);
  await saveData('party');
  closeModal('modal-party');
  renderParty();
}

async function deleteParty(id) {
  if (!confirm('Delete?')) return;
  state.data.party = state.data.party.filter(x => x.id !== id);
  await saveData('party');
  renderParty();
}

const relTypeBadge = { Bond:'badge-green', Rivalry:'badge-yellow', Romance:'badge-red', Conflict:'badge-red', Debt:'badge-purple', Secret:'badge-gray', Mentor:'badge-purple' };

function renderParty() {
  const el = document.getElementById('party-list');
  if (!state.data.party.length) {
    el.innerHTML = emptyState('üé≠','No relationships logged','Track bonds, feuds, and secrets between characters','+ Add Relationship','openPartyModal()');
    return;
  }

  el.innerHTML = state.data.party.map(p => `
    <div class="card">
      <div class="card-top">
        <div>
          <div class="card-title">${escHtml(p.charA)} ‚Üî ${escHtml(p.charB)}</div>
        </div>
        <span class="badge ${relTypeBadge[p.type]||'badge-gray'}">${p.type}</span>
      </div>
      ${p.desc ? `<div class="card-body">${escHtml(p.desc.slice(0,120))}‚Ä¶</div>` : ''}
      ${p.secrets ? `<div class="card-body" style="margin-top:6px;color:var(--text3)">ü§´ ${escHtml(p.secrets.slice(0,80))}‚Ä¶</div>` : ''}
      <div class="card-actions">
        <button class="btn btn-ghost" onclick="openPartyModal('${p.id}')">Edit</button>
        <button class="btn btn-danger" onclick="deleteParty('${p.id}')">Delete</button>
      </div>
    </div>
  `).join('');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  MEMORY LOG
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function openMemoryModal(id = null) {
  if (!state.currentCampaign) return alert('Select a campaign first');
  editingId.memory = id;
  document.getElementById('memory-modal-title').textContent = id ? 'Edit Memory' : 'Add Memory';
  const m = id ? state.data.memory.find(x => x.id === id) : null;
  document.getElementById('m-type').value = m?.type ?? 'Quote';
  document.getElementById('m-title').value = m?.title ?? '';
  document.getElementById('m-desc').value = m?.desc ?? '';
  document.getElementById('m-attr').value = m?.attr ?? '';
  document.getElementById('m-session').value = m?.session ?? '';
  openModal('modal-memory');
}

async function saveMemory() {
  const id = editingId.memory;
  const obj = {
    id: id || uid(),
    type: document.getElementById('m-type').value,
    title: document.getElementById('m-title').value.trim(),
    desc: document.getElementById('m-desc').value.trim(),
    attr: document.getElementById('m-attr').value.trim(),
    session: document.getElementById('m-session').value
  };
  if (!obj.title) return alert('Title required');
  if (id) state.data.memory[state.data.memory.findIndex(x => x.id === id)] = obj;
  else state.data.memory.push(obj);
  await saveData('memory');
  closeModal('modal-memory');
  renderMemory();
}

async function deleteMemory(id) {
  if (!confirm('Delete?')) return;
  state.data.memory = state.data.memory.filter(x => x.id !== id);
  await saveData('memory');
  renderMemory();
}

const memTypeIcon = { Quote:'üí¨', Combat:'‚öîÔ∏è', 'Inside Joke':'üòÇ', 'Death Save':'üíÄ', 'Critical Hit':'üéØ', Achievement:'üèÜ', Other:'‚ú®' };

function renderMemory() {
  const el = document.getElementById('memory-list');
  if (!state.data.memory.length) {
    el.innerHTML = emptyState('üî•','No memories yet','Log the moments that built your legend','+ Add Entry','openMemoryModal()');
    return;
  }

  const byType = {};
  state.data.memory.forEach(m => { (byType[m.type] = byType[m.type]||[]).push(m); });

  el.innerHTML = Object.entries(byType).map(([type, items]) => `
    <div style="margin-bottom:24px">
      <div class="section-title">${memTypeIcon[type]||'‚ú®'} ${type}</div>
      ${items.map(m => m.type === 'Quote' ? `
        <div class="quote-item">
          <div class="quote-text">${escHtml(m.title)} ${m.desc ? '‚Äî ' + escHtml(m.desc.slice(0,80)) : ''}</div>
          <div class="quote-attr">${m.attr ? '‚Äî ' + escHtml(m.attr) : ''}${m.session ? ' ‚Ä¢ Session #'+m.session : ''}</div>
          <div style="margin-top:6px">
            <button class="btn btn-ghost" style="padding:2px 8px;font-size:10px" onclick="openMemoryModal('${m.id}')">Edit</button>
            <button class="btn btn-danger" style="padding:2px 8px;font-size:10px" onclick="deleteMemory('${m.id}')">‚úï</button>
          </div>
        </div>
      ` : `
        <div class="card" style="margin-bottom:8px">
          <div class="card-top">
            <div class="card-title">${escHtml(m.title)}</div>
            ${m.session ? `<span class="badge badge-gray">Session #${m.session}</span>` : ''}
          </div>
          ${m.desc ? `<div class="card-body">${escHtml(m.desc)}</div>` : ''}
          ${m.attr ? `<div class="card-meta" style="margin-top:6px">‚Äî ${escHtml(m.attr)}</div>` : ''}
          <div class="card-actions">
            <button class="btn btn-ghost" onclick="openMemoryModal('${m.id}')">Edit</button>
            <button class="btn btn-danger" onclick="deleteMemory('${m.id}')">Delete</button>
          </div>
        </div>
      `).join('')}
    </div>
  `).join('');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  REPUTATION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function openReputationModal(id = null) {
  if (!state.currentCampaign) return alert('Select a campaign first');
  editingId.rep = id;
  document.getElementById('rep-modal-title').textContent = id ? 'Edit Faction' : 'Add Faction';
  const r = id ? state.data.reputation.find(x => x.id === id) : null;
  document.getElementById('r-name').value = r?.name ?? '';
  document.getElementById('r-desc').value = r?.desc ?? '';
  document.getElementById('r-score').value = r?.score ?? 50;
  document.getElementById('r-notes').value = r?.notes ?? '';
  openModal('modal-reputation');
}

async function saveReputation() {
  const id = editingId.rep;
  const obj = {
    id: id || uid(),
    name: document.getElementById('r-name').value.trim(),
    desc: document.getElementById('r-desc').value.trim(),
    score: parseInt(document.getElementById('r-score').value) || 50,
    notes: document.getElementById('r-notes').value.trim()
  };
  if (!obj.name) return alert('Name required');
  if (id) state.data.reputation[state.data.reputation.findIndex(x => x.id === id)] = obj;
  else state.data.reputation.push(obj);
  await saveData('reputation');
  closeModal('modal-reputation');
  renderReputation();
}

async function deleteReputation(id) {
  if (!confirm('Delete?')) return;
  state.data.reputation = state.data.reputation.filter(x => x.id !== id);
  await saveData('reputation');
  renderReputation();
}

function repLabel(score) {
  if (score >= 80) return { label:'Heroic', color:'#47ff87' };
  if (score >= 60) return { label:'Favored', color:var_accent };
  if (score >= 40) return { label:'Neutral', color:'var(--text2)' };
  if (score >= 20) return { label:'Distrusted', color:'orange' };
  return { label:'Hated', color:'var(--accent3)' };
}

const var_accent = 'var(--accent)';

function renderReputation() {
  const el = document.getElementById('reputation-list');
  if (!state.data.reputation.length) {
    el.innerHTML = emptyState('üîÑ','No factions tracked','Monitor how different groups view your party','+ Add Faction','openReputationModal()');
    return;
  }

  el.innerHTML = state.data.reputation.map(r => {
    const info = repLabel(r.score);
    return `
    <div class="settings-block" style="margin-bottom:12px">
      <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:12px">
        <div>
          <div class="card-title">${escHtml(r.name)}</div>
          ${r.desc ? `<div class="card-meta">${escHtml(r.desc.slice(0,80))}</div>` : ''}
        </div>
        <span class="badge badge-gray" style="color:${info.color}">${info.label}</span>
      </div>
      <div class="rep-bar-wrap">
        <div class="rep-bar-label">
          <span style="font-family:var(--mono);font-size:11px;color:var(--text3)">Reputation</span>
          <span style="font-family:var(--mono);font-size:11px;color:var(--text2)">${r.score}/100</span>
        </div>
        <div class="rep-bar-bg">
          <div class="rep-bar-fill" style="width:${r.score}%"></div>
        </div>
      </div>
      ${r.notes ? `<div class="card-body">${escHtml(r.notes)}</div>` : ''}
      <div class="card-actions">
        <button class="btn btn-ghost" onclick="openReputationModal('${r.id}')">Edit</button>
        <button class="btn btn-danger" onclick="deleteReputation('${r.id}')">Delete</button>
      </div>
    </div>`;
  }).join('');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  UTILS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function escHtml(str) {
  return (str || '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  BOOT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

(async function init() {
  loadSettings();

  if (GH.owner && GH.repo && GH.token) {
    setStatus('loading', 'Connecting‚Ä¶');
    await loadCampaigns();
  } else {
    setStatus('err', 'Not configured');
    document.getElementById('no-campaign').style.display = 'flex';
    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  }
})();
</script>
</body>
</html>
